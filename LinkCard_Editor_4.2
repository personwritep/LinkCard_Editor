// ==UserScript==
// @name         LinkCard Editor ‚≠ê
// @namespace    http://tampermonkey.net/
// @version      4.2
// @description  ÈÄöÂ∏∏Ë°®Á§∫„Åß„É™„É≥„ÇØ„Ç´„Éº„Éâ„ÇíÁ∑®ÈõÜ „ÄåCtrl+F6„Äç
// @author       personwritep
// @match        https://blog.ameba.jp/ucs/entry/srventry*
// @exclude      https://blog.ameba.jp/ucs/entry/srventrylist.do*
// @grant         none
// ==/UserScript==


let mode=0; // „ÉÑ„Éº„É´„ÅÆON/OFF
let mode_e=0; // „ÉÜ„Ç≠„Çπ„ÉàÁ∑®ÈõÜ„É¢„Éº„ÉâÔºàenhanceÔºâ
let mode_c=0; // „Çµ„Éñ„Ç≥„É≥„Éà„É≠„Éº„É´

let retry=0;
let interval=setInterval(wait_target, 100);
function wait_target(){
    retry++;
    if(retry>10){
        clearInterval(interval); }
    let target=document.querySelector('#cke_1_contents');
    if(target){
        clearInterval(interval);
        main(); }}



function main(){
    let editor_iframe;
    let iframe_doc;
    let iframe_body;
    let selection;
    let range;

    let ua=0;
    let agent=window.navigator.userAgent.toLowerCase();
    if(agent.indexOf('firefox')>-1){ ua=1; }

    let read_json=localStorage.getItem('LinkCard Style');
    let lcard_set=JSON.parse(read_json);
    if(!Array.isArray(lcard_set)){
        lcard_set=
            [0, 0, "white", 1, "#e2e2e2", 0, "#333", "red", "", "", 4, 0]; }
    if(lcard_set.length<12){
        lcard_set[6]="#333";
        lcard_set[7]="red";
        lcard_set[8]="";
        lcard_set[9]="";
        lcard_set[10]=4;
        lcard_set[11]=0; }

    let write_json=JSON.stringify(lcard_set);
    localStorage.setItem('LinkCard Style', write_json);


    let target0=document.querySelector('#cke_1_contents');
    let monitor0=new MutationObserver( catch_key );
    monitor0.observe(target0, {childList: true});

    catch_key();

    function catch_key(){
        editor_iframe=document.querySelector('.cke_wysiwyg_frame');
        if(editor_iframe){
            iframe_doc=editor_iframe.contentWindow.document;
            if(iframe_doc){

                when_back();

                iframe_doc.addEventListener('keydown', check_key);
                document.addEventListener('keydown', check_key);

                function check_key(event){
                    if(event.ctrlKey && event.keyCode==117){
                        event.preventDefault();
                        event.stopImmediatePropagation();
                        if(mode==0 && editor_iframe){
                            mode=1;
                            sign();
                            card_edit(); }
                        else if(mode==1 && editor_iframe){
                            mode=0;
                            mode_e=0;
                            mode_c=0;
                            sign_clear();
                            card_close(); }}

                    if(event.keyCode==116){
                        event.preventDefault();
                        event.stopImmediatePropagation();
                        alert(
                            "„ÄÄ‚õî„ÄÄF5 / Ctrl + F5 / Shift + F5„ÄÄ\n"+
                            "„ÄÄ„ÄÄ„ÄÄ„ÄÄ„Åì„ÅÆ„Ç∑„Éß„Éº„Éà„Ç´„ÉÉ„Éà„ÅØÁèæÂú®„ÅÆ„Éö„Éº„Ç∏„ÇíÈÅ∑Áßª„Åó„Å¶„ÄÅÁ∑®ÈõÜ‰∏≠„ÅÆ\n"+
                            "„ÄÄ„ÄÄ„ÄÄ„ÄÄ„Éá„Éº„Çø„ÇíÊêçÂ§±„Åô„ÇãÂèØËÉΩÊÄß„Åå„ÅÇ„Çã„ÅÆ„Åß„ÄÅÁÑ°Âäπ„Å´„Åó„Å¶„ÅÑ„Åæ„Åô„ÄÇ\n"+
                            "„ÄÄ„ÄÄ„ÄÄ„ÄÄ„ÄÄ„ÄÄ-----„ÄÄLinkCard Editor„ÄÄ-----"); }}}}

        before_end();

    } // catch_key()



    function when_back(){
        if(mode==1){
            sign();
            card_close();
            mode_e=0;
            mode_c=0;
            card_edit(); }}



    function card_close(){
        iframe_body=iframe_doc.querySelector('body');
        if(iframe_body){
            selection=iframe_doc.getSelection();
            selection.removeAllRanges();

            let target_card=iframe_body.querySelectorAll('.ogpCard_root');
            for(let k=0; k<target_card.length; k++){
                if(target_card[k].classList.contains('edit_card')){
                    target_card[k].classList.remove('edit_card');
                    if(target_card[k].classList.contains('edit_card_e')){
                        target_card[k].classList.remove('edit_card_e');
                        edit_span_end(target_card[k]); }}}

            sens_help(0); }}



    function card_edit(){
        iframe_body=iframe_doc.querySelector('body');
        if(iframe_body){
            let target_card=iframe_body.querySelectorAll('.ogpCard_root');
            for(let k=0; k<target_card.length; k++){
                target_card[k].addEventListener('click', function(event){
                    set_card(target_card[k], event); }); } // CardÁ∑®ÈõÜÈñãÂßã

            function set_card(card, event){
                event.preventDefault();
                event.stopImmediatePropagation();

                if(mode==1 && card.classList.contains('edit_card')){ // ÂØæË±°„Ç´„Éº„Éâ„Åß„ÅÆÊìç‰Ωú
                    if(mode_e==0 &&
                       area_match(card, event) && (event.ctrlKey || event.shiftKey)){ // Á∑®ÈõÜÈÅ∏Êäû
                        mode_e=1;
                        sens_help(2);
                        mode_enhance(card, event); }
                    if(mode_e==1){
                        if(!area_match(card, event)){ // Á∑®ÈõÜÁµÇ‰∫Ü
                            mode_e=0;
                            sens_help(1);
                            mode_no_enhance(card); }
                        else{
                            if(area_match(card, event).style.zIndex!='1'){
                                if(event.ctrlKey || event.shiftKey){ // Á∑®ÈõÜÁßªÂãï
                                    edit_span_end(card);
                                    selection.removeAllRanges();
                                    mode_e=1;
                                    sens_help(2);
                                    mode_enhance(card, event); }}}}}

                if(mode==1 &&
                   !card.classList.contains('edit_card') && event.ctrlKey){ // ÂØæË±°„Ç´„Éº„ÉâÁßªÂãï
                    mode_e=0;
                    mode_c=1;
                    card_close(); // ‰ªñ„ÅÆCard„ÇíÈñâ„Åò„Çã
                    card.classList.add('edit_card');
                    sens_help(1);
                    url_reset();
                    edit_in(card); }}

        }} // card_edit()



    function sens_help(n){
        let e_hint=document.querySelector('#disp_le .e_hint');
        if(e_hint){
            if(n==0){
                e_hint.innerHTML=''; }
            if(n==1){
                e_hint.innerHTML=
                    '„ÄÄ„ÄÄ„ÉÜ„Ç≠„Çπ„ÉàÁ∑®ÈõÜÔºöCtrl+Click'; }
            if(n==2){
                e_hint.innerHTML=
                    '„ÄÄ„ÄÄ„ÉÜ„Ç≠„Çπ„ÉàÁ∑®ÈõÜÁµÇ‰∫ÜÔºöCtrl+Click„ÄÄ„ÄÄ„ÉÜ„Ç≠„Çπ„Éà„ÇíÂÖ®ÈÅ∏ÊäûÔºöShift+Click'+
                    '„ÄÄ„ÄÄ„ÄÄ„ÄÄ„ÄÄ„ÄÄ„ÄÄ„ÄÄ„ÄÄ„ÄÄ„ÄÄ„ÄÄ„ÄÄ„ÄÄ'; }}}



    function area_match(card, event){ // „Ç´„Éº„Éâ‰∏ä„ÅÆ„ÇØ„É™„ÉÉ„ÇØÂ†¥ÊâÄ„ÅÆÂà§ÂÆö
        let elem=iframe_doc.elementFromPoint(event.clientX, event.clientY);
        let select_parent;
        if(elem.textContent){
            if(elem.closest('.ogpCard_title')){
                select_parent=card.querySelector('.ogpCard_title'); }
            if(elem.closest('.ogpCard_description')){
                select_parent=card.querySelector('.ogpCard_description'); }
            if(elem.closest('.ogpCard_urlText')){
                select_parent=card.querySelector('.ogpCard_urlText'); }}
        return select_parent; }



    function mode_enhance(card, event){ // TEXTÁ∑®ÈõÜ„Åô„Çã
        let target=area_match(card, event);

        if(event.ctrlKey){
            edit_span(target, 0); } // ÂØæË±°SPAN„ÇíÁ∑®ÈõÜ üí¢
        else if(event.shiftKey){
            edit_span(target, 1); } // ÂØæË±°SPAN„ÇíÈÅ∏Êäû üí¢

        if(!card.classList.contains('edit_card_e')){
            card.classList.add('edit_card_e'); }

        let link=card.querySelector('.ogpCard_link');
        if(link){
            link.setAttribute('draggable', 'false'); }} // firefox„ÅßÂøÖË¶Å



    function mode_no_enhance(card){
        if(card.classList.contains('edit_card_e')){
            card.classList.remove('edit_card_e'); }

        let link=card.querySelector('.ogpCard_link');
        if(link.hasAttribute('draggable')){
            link.removeAttribute('draggable'); } // firefox„ÅßÂøÖË¶Å

        edit_span_end(card); // Á∑®ÈõÜ‰∏çËÉΩ„Å´Êàª„Åô
        selection.removeAllRanges(); }



    function edit_span(elem, n){
        elem.setAttribute('contenteditable', 'true');
        elem.style.zIndex='1';
        elem.style.outline='2px solid #2196f3';
        elem.style.outlineOffset='3px';
        if(n==1){
            selection=iframe_doc.getSelection();
            range=iframe_doc.createRange();
            range.selectNodeContents(elem);
            selection.removeAllRanges();
            selection.addRange(range); }}



    function edit_span_end(card){
        let spans=card.querySelectorAll('span');
        for(let k=0; k<spans.length; k++){
            if(spans[k].hasAttribute('contenteditable')){
                last_br(spans[k]);
                spans[k].removeAttribute('contenteditable');
                spans[k].style.zIndex='';
                spans[k].style.outline='';
                spans[k].style.outlineOffset=''; }}

        function last_br(elem){
            let elem_nodes=elem.childNodes;
            for(let k=elem_nodes.length-1; k>=0; k--){
                if(elem_nodes[k].nodeName=='BR'){
                    if(elem_nodes[k]==elem.lastChild){
                        elem_nodes[k].remove(); }}
                else if(elem_nodes[k].nodeName!='#text'){
                    if(elem_nodes[k].nodeName!='SPAN' &&
                       elem_nodes[k].nodeName!='IMG'){
                        elem_nodes[k].outerHTML=elem_nodes[k].textContent; }}}}}



    function edit_in(card){
        if(mode==1){
            if(!card.style.textAlign){
                card.style.textAlign='center'; } // „Éá„Éï„Ç©„É´„Éà„Åß‰∏≠Â§ÆÈÖçÁΩÆ

            let card_link=card.querySelector('.ogpCard_link');
            if(!card.querySelector('.ogpCard_imageWrap')){
                let imgw=document.createElement('span');
                imgw.setAttribute('class', 'ogpCard_imageWrap');
                imgw.setAttribute('style', 'position:relative; width:120px; height:120px; '+
                                  'flex-shrink:0; border: 1px solid #eee;');
                card_link.appendChild(imgw); } // „Ç´„Éê„ÉºÁîªÂÉè„ÅåÁÑ°„ÅÑÂ†¥Âêà„Å´Ë°®Á§∫„Ç®„É™„Ç¢Á¢∫‰øù

            slim_title(card);
            slim_icon(card);

            item_setter(card);
            align_in(card);
            size_in(card);
            bg_color(card);
            tx_color(card);
            set_url(card);
            query_cut(card);
            bd_color(card);
            bd_width(card);
            bd_radius(card);
            svg_icon(card);
            mem_plus(card);
            mem_paste(card);
            moz(card);

        }} // edit_in()



    function slim_title(card){ // ÂÖàÈ†≠„ÉªÊú´Â∞æ„ÅÆ„Äé„Äè„ÇíÂâäÈô§
        if(card.classList.contains('edit_card')){
            let link=card.querySelector('.ogpCard_link');
            if(link.getAttribute('href').includes('https://ameblo.jp/')){
                let title=card.querySelector('.ogpCard_title');
                if(title){
                    let title_str=title.innerHTML;
                    if(title_str.slice(0, 1)=='„Äé' && title_str.slice(-1)=='„Äè'){
                        title_str=title_str.slice(1).slice(0, -1); }
                    title.innerHTML=title_str; }}}}



    function slim_icon(card){ // „É™„É≥„ÇØ„Éû„Éº„ÇØ„Çí„ÉÜ„Ç≠„Çπ„ÉàÂåñ
        let link_svg=
            '<svg height="14" width="20" viewBox="0 0 32 36">'+
            '<path d="M16 20C14 15 14 13 18 9C20 7 24 4 26 7C27 10 23 16 23 '+
            '19C25 18 27 16 29 14C32 9 30 1 23 1C15 2 4 17 16 20M16 12C18 17 '+
            '18 19 14 23C12 25 8 28 6 25C5 22 9 16 9 13C7 14 5 16 3 18C-0 23 2 '+
            '31 9 31C17 30 28 15 16 12z"></path></svg>';

        let url=card.querySelector('.ogpCard_url');
        if(url){
            url.style.margin='auto 0 0 20px'; }
        let iconWrap=card.querySelector('.ogpCard_iconWrap');
        if(iconWrap){
            if(card.querySelector('.ogpCard_icon')){
                iconWrap.innerHTML=link_svg;
                iconWrap.style.fill='currentColor';
                iconWrap.style.height='20px';
                iconWrap.style.position='';
                iconWrap.style.width='';
                iconWrap.style.flexShrink=''; }}
        let urlText=card.querySelector('.ogpCard_urlText');
        if(urlText){
            urlText.style.fontSize='13px'; }}



    function item_setter(card){
        let target_i=document.querySelector('#js-photos-imageList');
        let monitor_i=new MutationObserver(item_select);
        monitor_i.observe(target_i, {childList: true, subtree: true}); // ÁîªÂÉè„Éë„É¨„ÉÉ„ÉàÁõ£Ë¶ñ

        item_select();

        function item_select(){
            let item=document.querySelectorAll('.p-images-imageList__item');
            for(let k=0; k<item.length; k++){
                item[k].addEventListener('click', function(event){
                    set_img(event, item[k]); }); }}

        function set_img(e, item){
            if(mode==1){
                e.stopImmediatePropagation();
                let img_src=item.getAttribute('data-image');
                let inner=
                    '<img alt="" class="ogpCard_image" data-ogp-card-image="" '+
                    'height="120" loading="lazy" data-cke-saved-src="' + img_src +
                    '" src="' + img_src +
                    '" style="position:absolute;top:50%;left:50%;object-fit:cover;'+
                    'min-height:100%;min-width:100%;'+
                    'transform:translate(-50%,-50%)" width="120">';

                editor_iframe=document.querySelector('.cke_wysiwyg_frame');
                if(editor_iframe){
                    let target_card=iframe_body.querySelectorAll('.ogpCard_root');
                    for(let k=0; k<target_card.length; k++){
                        if(target_card[k].classList.contains('edit_card')){
                            range_con(target_card[k]);
                            let card_imgw=
                                target_card[k].querySelector('.ogpCard_imageWrap');
                            if(card_imgw){
                                card_imgw.innerHTML=inner; }}}

                    function range_con(card){
                        if(mode==1){
                            selection=iframe_doc.getSelection();
                            range=iframe_doc.createRange();
                            range.setStart(card, 0);
                            range.setEnd(card, 0);
                            selection.removeAllRanges();
                            selection.addRange(range); }}

                }}} // set_img()


        item_sign(card);

        function item_sign(card){
            let photos_w=document.querySelector('#js-photos-wrapper');
            photos_w.addEventListener('mouseover', function(){
                let imageWrap=card.querySelector('.ogpCard_imageWrap');
                if(imageWrap && card.classList.contains('edit_card')){
                    imageWrap.style.filter='invert(1)';
                    imageWrap.style.background='#442814'; }});

            photos_w.addEventListener('mouseout', function(){
                let imageWrap=card.querySelector('.ogpCard_imageWrap');
                if(imageWrap && card.classList.contains('edit_card')){
                    imageWrap.style.filter='';
                    imageWrap.style.background=''; }}); }

    } // item_setter()



    function align_in(card){
        let al=document.querySelector('#disp_le .al');
        let ac=document.querySelector('#disp_le .ac');
        let ar=document.querySelector('#disp_le .ar');
        al.onclick=function(){
            if(card.style.textAlign!='left'){
                if(card.classList.contains('edit_card')){
                    card.style.textAlign='left'; }}}
        ac.onclick=function(){
            if(card.classList.contains('edit_card')){
                if(card.style.textAlign!='center'){
                    card.style.textAlign='center'; }}}
        ar.onclick=function(){
            if(card.classList.contains('edit_card')){
                if(card.style.textAlign!='right'){
                    card.style.textAlign='right'; }}}

    } // arrange_in()



    function size_in(card){
        let lz=document.querySelector('#disp_le .lz');
        lz.onclick=function(event){
            let link=card.querySelector('.ogpCard_link');
            if(card.classList.contains('edit_card')){
                if(event.ctrlKey){
                    ex_compact(card); }
                else{
                    if(mode_e==1){
                        mode_e=0;
                        mode_no_enhance(card); }
                    else{
                        if(link){
                            if(link.style.height=='108px'){
                                arrange_min(card); }
                            else if(link.style.height=='auto'){
                                arrange_default(card); }
                            else{ // Êú™„Ç¢„É¨„É≥„Ç∏„ÅØ compact„Å´Â§âÊõ¥
                                arrange_compact(card); }}}}}}

    } // size_in()



    function ex_compact(card){
        let ok=confirm(
            "„ÄÄ„ÄÄ„ÄÄüí¢ „É™„É≥„ÇØ„Ç´„Éº„Éâ„ÅÆÂ∞èÂûãÊúÄËªΩÈáèÂåñ„Ç™„Éó„Ç∑„Éß„É≥\n\n"+
            "„ÄÄ„ÄÄ„ÄåOK„Äç „ÇíÊäº„Åô„Å® „Äå„Ç´„Éê„ÉºÁîªÂÉè„Äç„ÄåË®ò‰∫ã„ÅÆÊú¨ÊñáÈÉ®„Äç „ÇíÂâäÈô§„Åó„Åæ„Åô„ÄÇ\n"+
            "„ÄÄ„ÄÄ ËªΩÈáèÂåñ„ÇíÂÖÉ„Å´Êàª„Åô„Å´„ÅØ„ÄÅ„Ç´„Éº„Éâ„ÇíÊúÄÂàù„Åã„Çâ‰Ωú„ÇäÁõ¥„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ");

        if(ok){
            if(card.classList.contains('edit_card')){
                arrange_ex_compact(card); }
            mode_e=0; // „ÉÜ„Ç≠„Çπ„ÉàÁ∑®ÈõÜ„É¢„Éº„Éâ„ÅÆ„É™„Çª„ÉÉ„Éà
            mode_no_enhance(card); }
        else{ ; }} // ex_compact()



    function arrange_ex_compact(card){
        let link=card.querySelector('.ogpCard_link');
        if(link){
            link.style.width='500px';
            link.style.height='';
            link.style.margin='';
            link.style.boxSizing=''; }
        let content=card.querySelector('.ogpCard_content');
        if(content){
            content.style.padding='7px 15px 4px 15px';
            content.style.flexDirection='';
            content.style.overflow='';
            content.style.justifyContent='inherit'; }
        let title=card.querySelector('.ogpCard_title');
        if(title){
            title.style.WebkitBoxOrient='';
            title.style.display='';
            title.style.WebkitLineClamp='';
            title.style.maxHeight='19px';
            title.style.flexShrink='';
            title.style.font='bold 16px/1.25 Meiryo'; }
        let description=card.querySelector('.ogpCard_description');
        if(description){
            description.remove(); }
        let url=card.querySelector('.ogpCard_url');
        if(url){
            url.style.margin=''; }
        let urlText=card.querySelector('.ogpCard_urlText');
        if(urlText){
            urlText.style.overflow='';
            urlText.style.textOverflow='';
            urlText.style.textAlign=''; }
        let imageWrap=card.querySelector('.ogpCard_imageWrap');
        if(imageWrap){
            imageWrap.remove(); }


        let ogpCard_wrap=card.querySelector('.ogpCard_wrap');
        if(ogpCard_wrap){
            ogpCard_wrap.removeAttribute('contenteditable'); }

        if(link){
            link.removeAttribute('data-ogp-card-log');
            link.removeAttribute('data-cke-saved-href');

            let fake=document.createElement("img");
            if(!link.querySelector('img')){
                link.appendChild(fake); }}

        let all_obj=card.querySelectorAll('*');
        for(let k=0; k<all_obj.length; k++){
            all_obj[k].classList.remove(
                'ogpCard_wrap', 'ogpCard_content', 'ogpCard_title',
                'ogpCard_url', 'ogpCard_iconWrap', 'ogpCard_urlText'); }
        card.classList.remove('ogpCard_root', 'edit_card');

        let dupe=card.cloneNode(true);
        card.parentNode.replaceChild(dupe, card); }



    function arrange_compact(card){
        let link=card.querySelector('.ogpCard_link');
        if(link){
            link.style.width='500px';
            link.style.height='108px';
            link.style.margin='0 auto';
            link.style.boxSizing=''; }
        let content=card.querySelector('.ogpCard_content');
        if(content){
            content.style.padding='8px 25px 4px 15px';
            content.style.flexDirection='column';
            content.style.justifyContent='inherit'; }
        let title=card.querySelector('.ogpCard_title');
        if(title){
            title.style.maxHeight='39px';
            title.style.flexShrink='0';
            title.style.font='bold 16px/1.25 Meiryo';
            title.style.WebkitLineClamp='2'; }
        let description=card.querySelector('.ogpCard_description');
        if(description){
            description.style.whiteSpace='';
            description.style.margin='0';
            description.style.font='13px/1.4 Meiryo';
            description.style.display=''; }
        let url=card.querySelector('.ogpCard_url');
        if(url){
            url.style.margin='auto 0 0 20px'; }
        let imageWrap=card.querySelector('.ogpCard_imageWrap');
        if(imageWrap){
            imageWrap.style.width='98px';
            imageWrap.style.height='98px';
            imageWrap.style.margin='auto 0';
            imageWrap.style.top='';
            imageWrap.style.right='15px';
            imageWrap.style.border='1px solid #eee';
            imageWrap.style.display=''; }}



    function arrange_min(card){
        let link=card.querySelector('.ogpCard_link');
        if(link){
            link.style.width='500px';
            link.style.height='auto';
            link.style.margin='0 auto';
            link.style.boxSizing=''; }
        let content=card.querySelector('.ogpCard_content');
        if(content){
            content.style.padding='7px 15px 4px 15px';
            content.style.flexDirection='row';
            content.style.justifyContent='inherit'; }
        let title=card.querySelector('.ogpCard_title');
        if(title){
            title.style.maxHeight='19px';
            title.style.flexShrink='1';
            title.style.font='bold 16px/1.25 Meiryo';
            title.style.WebkitLineClamp='1'; }
        let description=card.querySelector('.ogpCard_description');
        if(description){
            description.style.whiteSpace='';
            description.style.margin='0';
            description.style.font='13px/1.4 Meiryo';
            description.style.display='none'; }
        let url=card.querySelector('.ogpCard_url');
        if(url){
            url.style.margin='0'; }
        let imageWrap=card.querySelector('.ogpCard_imageWrap');
        if(imageWrap){
            imageWrap.style.width='';
            imageWrap.style.height='';
            imageWrap.style.margin='';
            imageWrap.style.top='';
            imageWrap.style.right='';
            imageWrap.style.border='';
            imageWrap.style.display='none'; }}



    function arrange_default(card){
        let link=card.querySelector('.ogpCard_link');
        if(link){
            link.style.width='620px';
            link.style.height='120px';
            link.style.margin='';
            link.style.boxSizing='border-box'; }
        let content=card.querySelector('.ogpCard_content');
        if(content){
            content.style.padding='16px 16px 12px';
            content.style.flexDirection='column';
            content.style.justifyContent='inherit';
            content.style.backgroundColor=''; }
        let title=card.querySelector('.ogpCard_title');
        if(title){
            title.style.maxHeight='44px';
            title.style.flexShrink='0';
            title.style.font='bold 16px/1.4 Meiryo';
            title.style.WebkitLineClamp='2'; }
        let description=card.querySelector('.ogpCard_description');
        if(description){
            description.style.whiteSpace='nowrap';
            description.style.marginTop='4px';
            description.style.font='12px/1.6 Meiryo';
            description.style.display=''; }
        let url=card.querySelector('.ogpCard_url');
        if(url){
            url.style.margin='auto 0 0 20px'; }
        let imageWrap=card.querySelector('.ogpCard_imageWrap');
        if(imageWrap){
            imageWrap.style.width='120px';
            imageWrap.style.height='120px';
            imageWrap.style.margin='';
            imageWrap.style.top='';
            imageWrap.style.right='';
            imageWrap.style.border='1px solid #e2e2e2';
            imageWrap.style.display=''; }}



    function bg_color(card){
        let set_color;
        let lc_color=document.querySelector('#lc_color');
        let lc_trance=document.querySelector('#lc_trance');
        let link=card.querySelector('.ogpCard_link');
        let link_bgc=link.style.backgroundColor;
        if(link_bgc){
            lc_color.style.backgroundColor=link_bgc;
            lc_trance.value=rgba_trance(link_bgc);
            set_color=link_bgc; }

        import_color(card, lc_color, link, 'bg');

        let target_elem=lc_color;
        let monitor_elem=new MutationObserver(import_c);
        monitor_elem.observe(target_elem, {attributes: true});
        function import_c(){
            if(target_elem.style.opacity==2){
                monitor_elem.disconnect();
                setTimeout(()=>{
                    lc_trance.value=1;
                    set_color=lc_color.style.backgroundColor;
                    target_elem.style.opacity=1;
                }, 40);
                monitor_elem.observe(target_elem, {attributes: true}); }}


        lc_trance.addEventListener('input', function(event){
            event.preventDefault();
            let set_color_tmp=rgba(set_color, lc_trance.value);
            let lc_color=document.querySelector('#lc_color');
            lc_color.style.backgroundColor=set_color_tmp;
            let link=card.querySelector('.ogpCard_link');
            if(card.classList.contains('edit_card')){
                link.style.backgroundColor=set_color_tmp; }});


        function rgba(c_val, alpha){ // ÈÄèÈÅéËâ≤„ÅÆÁôΩËÉåÊôØÊôÇ„ÅÆÈùûÈÄèÈÅéËâ≤„Å´Â§âÊèõ
            let R, G, B;
            let c_val_arr=c_val.split(',');
            if(c_val_arr.length==3){
            R=c_val_arr[0].replace(/[^0-9]/g, '');
            G=c_val_arr[1].replace(/[^0-9]/g, '');
            B=c_val_arr[2].replace(/[^0-9]/g, '');
            return 'rgb('+cpColor(R, alpha)+', '+cpColor(G, alpha)+', '+cpColor(B, alpha)+')'

            function cpColor(deci_code, alp){
                const colorCode=deci_code*alp + 255*(1 - alp);
                return Math.floor(colorCode).toString(10); }}
            else{
                return c_val; }}

    } // bg_color()



    function import_color(card, sw, target, type){
        let color_label;
        let icon_button;

        editor_iframe=document.querySelector('.cke_wysiwyg_frame');
        iframe_doc=editor_iframe.contentWindow.document;
        selection=iframe_doc.getSelection();

        if(ua==0){
            color_label=document.querySelector('#cke_16_label');
            icon_button=document.querySelector('#cke_17'); }
        else if(ua==1){
            color_label=document.querySelector('#cke_15_label');
            icon_button=document.querySelector('#cke_16'); }

        let target_p=color_label;
        let monitor_p=new MutationObserver(get_copy);

        sw.onclick=function(event){
            if(card.classList.contains('edit_card')){
                selection.removeAllRanges(); // Ë®ò‰∫ã‰∏≠„ÅÆÈÅ∏Êäû„Å´Ë™§ÊåáÂÆö„ÇíÈò≤Ê≠¢
                icon_button.click();
                monitor_p.observe(target_p, {attributes: true}); }}


        function get_copy(){
            if(card.classList.contains('edit_card')){
                if(type=='bg'){
                    sw.style.backgroundColor=color_label.style.backgroundColor;
                    target.style.backgroundColor=sw.style.backgroundColor;
                    sw.style.opacity=2; }
                if(type=='cl'){
                    sw.style.backgroundColor=color_label.style.backgroundColor;
                    target.style.color=sw.style.backgroundColor;
                    let iconWrap=card.querySelector('.ogpCard_iconWrap');
                    if(iconWrap){
                        iconWrap.style.fill='currentColor'; }
                    let svg=document.querySelector('#link_mark');
                    if(svg){
                        svg.style.color=sw.style.backgroundColor; }}
                if(type=='bd'){
                    sw.style.backgroundColor=color_label.style.backgroundColor;
                    target.style.borderColor=sw.style.backgroundColor; }
                if(type=='svg'){
                    sw.style.color=color_label.style.backgroundColor;
                    target.style.fill=sw.style.color; }}
            monitor_p.disconnect(); }


        document.addEventListener('mousedown', function(){
            monitor_p.disconnect(); });


        if(document.querySelector('.cke_wysiwyg_frame')!=null){
            editor_iframe=document.querySelector('.cke_wysiwyg_frame');
            if(editor_iframe){
                iframe_doc=editor_iframe.contentWindow.document;
                if(iframe_doc){
                    iframe_doc.addEventListener('mousedown', function(){
                        monitor_p.disconnect(); }); }}}


        let target_body=document.querySelector('.l-body');
        let monitor_generator=new MutationObserver(stealth);
        monitor_generator.observe(target_body, {childList: true, subtree: true});

        function stealth(){
            let color_generator=document.querySelector('.ck-l-colorGenerator');
            if(color_generator){
                color_generator.addEventListener('mousedown', function(event){
                    event.stopImmediatePropagation(); }); }}

    } // inport_color()



    function rgba_trance(color_val){
        let trance_val;
        let c_val_arr=color_val.split(',');
        if(c_val_arr.length!=4){
            trance_val=1; }
        else{
            trance_val=c_val_arr[3].replace(/[^0-9]/g, '')/10; }
        return trance_val; }



    function bg_reset(){
        let lc_color=document.querySelector('#lc_color');
        let lc_trance=document.querySelector('#lc_trance');
        lc_color.style.background='#fff';
        lc_trance.value=1; }



    function tx_color(card){ // Card„ÅÆÂü∫Êú¨ÊñáÂ≠óËâ≤ÊåáÂÆö
        let link=card.querySelector('.ogpCard_link');
        if(link.style.color==''){ // ÈÖçËâ≤„Åå„ÅÇ„ÇãÂ†¥Âêà„ÅØË®ÇÊ≠£„Åó„Å™„ÅÑ
            link.style.color='rgb(51, 51, 51)'; } // Card„ÅÆÂü∫Êú¨ÊñáÂ≠óËâ≤„ÇíÊåáÂÆö
        let title=card.querySelector('.ogpCard_title');
        if(title){
            title.style.color=''; }
        let description=card.querySelector('.ogpCard_description');
        if(description){
            description.style.color=''; }
        let urlText=card.querySelector('.ogpCard_urlText');
        if(urlText){
            urlText.style.color=''; }

        let tc_color=document.querySelector('#tc_color');
        tc_color.style.background=link.style.color;

        import_color(card, tc_color, link, 'cl');

    } // tx_color()



    function tx_reset(){
        let tc_color=document.querySelector('#tc_color');
        tc_color.style.background='#fff'; }



    function set_url(card){
        let url_wide=document.querySelector('#url_wide');
        let url_input=document.querySelector('#url_input');
        let url_clear=document.querySelector('#ex_disp .url_clear');
        let lw_h=document.querySelector('#lw_h');
        let write_url=document.querySelector('#write_url');


        url_input.onclick=function(){
            if(mode_c==1){
                if(!url_input.classList.contains('url_input_w')){
                    url_input.classList.add('url_input_w');
                    lw_h.classList.remove('lw_hint');
                    lw_h.classList.add('lw_hint_w');
                    url_wide.style.display='block'; }}}


        url_wide.onclick=function(event){
            event.stopImmediatePropagation();
            if(mode_c==1){
                if(url_input.classList.contains('url_input_w')){
                    url_input.classList.remove('url_input_w');
                    lw_h.classList.remove('lw_hint_w');
                    lw_h.classList.add('lw_hint');
                    url_wide.style.display='none'; }}}


        let link=card.querySelector('.ogpCard_link');
        let def_url=link.getAttribute('href');
        url_input.value=def_url;
        url_clear.onclick=function(event){
            event.stopImmediatePropagation();
            url_input.value=''; }


        write_url.onclick=function(event){
            let urlText=card.querySelector('.ogpCard_urlText');
            if(event.shiftKey){
                if(card.classList.contains('edit_card')){
                    if(urlText){
                        if(urlText.textContent==get_domain(card)){
                            urlText.textContent=def_url; } // card„ÅÆURL„ÇíË®òÂÖ•
                        else{
                            urlText.textContent=get_domain(card); }}}} // „Éâ„É°„Ç§„É≥Ë°®Á§∫
            else{
                rewrite(); }}


        url_input.onkeydown=function(event){
            if(event.keyCode==13){
                event.stopImmediatePropagation();
                event.preventDefault();
                rewrite(); }}


        function rewrite(){
            def_url=link.getAttribute('href');
            if(url_input.value!='' && url_input.value!=def_url){ // Â§âÊõ¥„ÅÇ„ÇãÂ†¥Âêà„ÅÆ„ÅøÂÆüË°å
                let ok=confirm(
                    "„ÄÄ„ÄÄ„ÄÄüí¢ „É™„É≥„ÇØ„Ç´„Éº„Éâ„ÅÆURLÊõ∏Êèõ„Åà„Ç™„Éó„Ç∑„Éß„É≥\n\n"+
                    "„ÄÄ„ÄÄÁèæÂú®„ÅÆ„ÄåURLÂÖ•ÂäõÊû†„Äç„ÅÆÂÜÖÂÆπ„Çí„É™„É≥„ÇØURL„Å´Ë®≠ÂÆö„Åó„Åæ„Åô„ÄÇ\n"+
                    "„ÄÄ„ÄÄÊõ∏Êèõ„ÅàÂæå„ÄÅ„Ç´„Éº„Éâ„ÇíÂè≥„ÇØ„É™„ÉÉ„ÇØ„Åó„Å¶Âà•„Ç¶„Ç§„É≥„Éâ„Ç¶„Å´„É™„É≥„ÇØÂÖà\n"+
                    "„ÄÄ„ÄÄ„ÇíÈñã„Åç„ÄÅÊ≠£„Åó„ÅèË®≠ÂÆö„Åï„Çå„Åü„Åã„ÇíÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ");

                if(ok){
                    if(card.classList.contains('edit_card')){
                        link.setAttribute('href', url_input.value);
                        let data_cke_saved_href=
                            link.getAttribute('data-cke-saved-href');
                        if(data_cke_saved_href){
                            link.setAttribute('data-cke-saved-href', url_input.value); }

                        url_input.style.background='#80deea';
                        setTimeout(()=>{
                            url_input.style.background='';
                        }, 1500); }}
                else{
                    url_input.style.background='#80deea';
                    url_input.value='ÁèæÂú®„ÅÆ„É™„É≥„ÇØURL„Å´Êàª„Åó„Åæ„Åô';
                    setTimeout(()=>{
                        url_input.style.background='';
                        url_input.value=def_url; // URLÂÖ•ÂäõÊû†ÂÜÖÂÆπ„ÇíÂÖÉ„Å´Êàª„Åô
                    }, 3000); }}
            else{
                url_input.value=def_url;
                if(url_input.classList.contains('url_input_w')){
                    url_input.classList.remove('url_input_w');
                    lw_h.classList.remove('lw_hint_w');
                    lw_h.classList.add('lw_hint');
                    url_wide.style.display='none'; }}}


        function get_domain(card){
            let domein=def_url.match(/^https?:\/{2,}(.*?)(?:\/|\?|#|$)/)[1];
            return domein; }

    } // set_url()



    function query_cut(card){
        let link=card.querySelector('.ogpCard_link');
        let url_input=document.querySelector('#url_input');

        let am_url=document.querySelector('#am_url');
        if(am_url){
            am_url.onclick=function(){
                let def_url=link.getAttribute('href');
                let smart_url;
                let product;

                if(def_url.indexOf('www.amazon.co')==-1){ // Amazon‰ª•Â§ñ
                    smart_url=cut_after(def_url, '?'); }
                else{ // Amazon„ÅÆÂ†¥Âêà
                    if(def_url.indexOf('/b/')==-1 && def_url.indexOf('/b?')==-1 &&
                       def_url.indexOf('/s/')==-1 && def_url.indexOf('/s?')==-1 &&
                       cut_before(def_url, '?').indexOf('node=')==-1){
                        if(def_url.indexOf('/gp/')!=-1){
                            product=cut_after(cut_before(cut_after(def_url, '?'), '/gp/'), '/ref=');
                            smart_url='https://www.amazon.co.jp'+ product; }
                        else if(def_url.indexOf('/dp/')!=-1){
                            product=cut_after(cut_before(cut_after(def_url, '?'), '/dp/'), '/ref=');
                            smart_url='https://www.amazon.co.jp'+ product; }
                        else{
                            smart_url=cut_after(def_url, '?'); }}
                    else{
                        smart_url=def_url; }}


                if(card.classList.contains('edit_card')){
                    link.setAttribute('href', smart_url);
                    let data_cke_saved_href=
                        link.getAttribute('data-cke-saved-href');
                    if(data_cke_saved_href){
                        link.setAttribute('data-cke-saved-href', smart_url); }

                    url_input.value=smart_url;
                    url_input.style.background='#80deea';
                    setTimeout(()=>{
                        url_input.style.background='';
                    }, 1500); }}}


        function cut_before(row, string){ // ÂâçÊñπ„ÇíÂâäÈô§
            let rs;
            if(row.indexOf(string)!=-1){
                rs=row.substring(row.indexOf(string));
                return rs; }
            else{
                return row; }}

        function cut_after(row, string){ // ‰ª•Èôç„ÇíÂâäÈô§
            let rs;
            if(row.indexOf(string)!=-1){
                rs=row.substring(0, row.indexOf(string));
                return rs; }
            else{
                return row; }}

    } // query_cut()



    function bd_color(card){
        let lb_color=document.querySelector('#lb_color');
        let link=card.querySelector('.ogpCard_link');
        let link_bc=link.style.borderColor;
        if(link_bc){
            lb_color.style.background=link_bc; }

        import_color(card, lb_color, link, 'bd');

    } // bd_color()



    function bd_width(card){
        let link=card.querySelector('.ogpCard_link');
        let lborder=document.querySelector('#lborder');
        let link_bw=parseInt(link.style.borderWidth);
        let lb_disp=document.querySelector('#lb_disp');
        if(link_bw || link_bw==0){
            lborder.value=link_bw; }
        if(mode_c==1){
            lb_disp.textContent=lborder.value+'px'; }

        lborder.onchange=function(){
            if(card.classList.contains('edit_card')){
                link.style.borderWidth=lborder.value+'px';
                lb_disp.textContent=lborder.value+'px'; }}}



    function bd_radius(card){
        let link=card.querySelector('.ogpCard_link');
        let lbr=document.querySelector('#lbr');
        let link_br=parseInt(link.style.borderRadius);
        let lbr_disp=document.querySelector('#lbr_disp');
        if(link_br || link_br==0){
            lbr.value=link_br; }
        if(mode_c==1){
            lbr_disp.textContent='R'+lbr.value; }

        lbr.onchange=function(){
            if(card.classList.contains('edit_card')){
                link.style.borderRadius=lbr.value+'px';
                lbr_disp.textContent='R'+lbr.value; }}}



    function bd_reset(){
        let lb_color=document.querySelector('#lb_color');
        lb_color.style.background='#fff';
        let lb_disp=document.querySelector('#lb_disp');
        lb_disp.textContent='„ÄÄ';
        let lbr_disp=document.querySelector('#lbr_disp');
        lbr_disp.textContent='„ÄÄ'; }



    function svg_icon(card){
        let svg=document.querySelector('#link_mark');
        let iconWrap=card.querySelector('.ogpCard_iconWrap');
        let svg_c=iconWrap.style.fill;
        if(!svg_c || svg_c=='currentcolor'){
            svg.style.color=window.getComputedStyle(iconWrap).color; }
        else{ svg.style.color=svg_c; }

        import_color(card, svg, iconWrap, 'svg');

    } // link_icon()



    function sv_reset(){
        let svg=document.querySelector('#link_mark');
        if(svg){
            svg.style.color='#fff'; }}



    function mem_plus(card){
        let memo_plus=document.querySelector('#memo_plus');
        if(memo_plus){
            memo_plus.onclick=function(){
                let ok=confirm(
                    "„ÄÄ„ÄÄ üü† ÁèæÂú®„ÅÆ„É™„É≥„ÇØ„Ç´„Éº„Éâ„ÅÆ„Éá„Ç∂„Ç§„É≥„ÇíÁôªÈå≤„Åó„Åæ„Åô\n"+
                    "„ÄÄ„ÄÄ„ÄÄ„ÄÄ„Åì„Çå„Åæ„Åß„ÅÆÁôªÈå≤„Çí‰∏äÊõ∏„Åç„Åó„Å¶ËâØ„ÅÑ„Åß„Åô„ÅãÔºü\n");

                if(ok){
                    if(card.classList.contains('edit_card')){
                        let link=card.querySelector('.ogpCard_link');
                        if(link){
                            if(link.style.height=='108px'){
                                lcard_set[0]=1; } // compact
                            else if(link.style.height=='auto'){
                                lcard_set[0]=2; } // min
                            else{
                                lcard_set[0]=0; } // Êú™„Ç¢„É¨„É≥„Ç∏

                            if(card.style.textAlign=='left'){
                                lcard_set[1]=1; }
                            else if(card.style.textAlign=='center'){
                                lcard_set[1]=2; }
                            else if(card.style.textAlign=='right'){
                                lcard_set[1]=3; }
                            else{
                                lcard_set[1]=0; }

                            let link_bgc=link.style.backgroundColor;
                            if(link_bgc){
                                lcard_set[2]=link_bgc; }

                            let link_bw=parseInt(link.style.borderWidth);
                            if(link_bw || link_bw==0){
                                lcard_set[3]=link_bw; }

                            let link_bc=link.style.borderColor;
                            if(link_bc){
                                lcard_set[4]=link_bc; }

                            let imageWrap=card.querySelector('.ogpCard_imageWrap');
                            if(!imageWrap){
                                lcard_set[5]=1; }
                            else{
                                lcard_set[5]=0; }

                            let link_tc=link.style.color;
                            if(link_tc){
                                lcard_set[6]=link_tc; }

                            let svg_col=document.querySelector('#link_mark').style.color;
                            if(svg_col){
                                lcard_set[7]=svg_col; }

                            let urlText=card.querySelector('.ogpCard_urlText');
                            if(urlText){
                                lcard_set[8]=urlText.style.fontWeight;
                                lcard_set[9]=urlText.style.color; }

                            let link_br=parseInt(link.style.borderRadius);
                            if(link_br || link_br==0){
                                lcard_set[10]=link_br; }

                            let write_json=JSON.stringify(lcard_set);
                            localStorage.setItem('LinkCard Style', write_json); // „Çπ„Éà„É¨„Éº„Ç∏‰øùÂ≠ò
                        }}}}

        }} // mem_plus()



    function mem_paste(card){
        let memo_paste=document.querySelector('#memo_paste');
        if(memo_paste){
            memo_paste.onclick=function(event){
                if(event.shiftKey){ //„Äå„Éâ„É°„Ç§„É≥Ë°®Á§∫ÈÉ®„Äç„Å´„ÄåÂº∑Ë™ø„Éá„Ç∂„Ç§„É≥„ÄçÈÅ©Áî®
                    if(card.classList.contains('edit_card')){
                        let iconWrap=card.querySelector('.ogpCard_iconWrap');
                        let urlText=card.querySelector('.ogpCard_urlText');
                        let svg=document.querySelector('#link_mark');
                        if(iconWrap && urlText && svg){
                            if(urlText.style.fontWeight==''){
                                iconWrap.style.fill='red';
                                urlText.style.color='#222';
                                urlText.style.fontWeight='bold';
                                svg.style.color='red'; }
                            else{
                                iconWrap.style.fill='currentColor';
                                urlText.style.color='';
                                urlText.style.fontWeight='';
                                svg.style.color=window.getComputedStyle(iconWrap).color; }}}}

                else{ // „Ç´„Éº„ÉâÂÖ®‰Ωì„Å´„ÄåÁôªÈå≤„Éá„Ç∂„Ç§„É≥„ÄçÈÅ©Áî®
                    if(card.classList.contains('edit_card')){
                        if(lcard_set[0]==1){
                            arrange_compact(card); }
                        else if(lcard_set[0]==2){
                            arrange_min(card); }
                        else{
                            arrange_default(card); }

                        if(lcard_set[1]==1){
                            if(card.style.textAlign!='left'){
                                card.style.textAlign='left'; }}
                        else if(lcard_set[1]==2){
                            if(card.style.textAlign!='center'){
                                card.style.textAlign='center'; }}
                        else if(lcard_set[1]==3){
                            if(card.style.textAlign!='right'){
                                card.style.textAlign='right'; }}
                        else{
                            if(card.style.textAlign!='left'){
                                card.style.textAlign='left'; }}

                        let link=card.querySelector('.ogpCard_link');
                        if(link){
                            link.style.backgroundColor=lcard_set[2];
                            let lc_color=document.querySelector('#lc_color');
                            lc_color.style.background=lcard_set[2];
                            let lc_trance=document.querySelector('#lc_trance');
                            lc_trance.value=rgba_trance(lcard_set[2]);

                            link.style.borderWidth=lcard_set[3]+'px';
                            let lborder=document.querySelector('#lborder');
                            lborder.value=lcard_set[3];
                            let lb_disp=document.querySelector('#lb_disp');
                            lb_disp.textContent=lborder.value+'px';

                            link.style.borderColor=lcard_set[4];
                            let lb_color=document.querySelector('#lb_color');
                            lb_color.style.background=lcard_set[4];

                            link.style.color=lcard_set[6];
                            let tc_color=document.querySelector('#tc_color');
                            tc_color.style.background=lcard_set[6];

                            link.style.borderRadius=lcard_set[10]+'px';
                            let lbr=document.querySelector('#lbr');
                            lbr.value=lcard_set[10];
                            let lbr_disp=document.querySelector('#lbr_disp');
                            lbr_disp.textContent='R'+lbr.value; }

                        let iconWrap=card.querySelector('.ogpCard_iconWrap');
                        if(iconWrap){
                            iconWrap.style.fill=lcard_set[7]; }
                        let svg=document.querySelector('#link_mark');
                        if(svg){
                            svg.style.color=lcard_set[7]; }

                        let urlText=card.querySelector('.ogpCard_urlText');
                        if(urlText){
                            urlText.style.fontWeight=lcard_set[8];
                            urlText.style.color=lcard_set[9]; }

                        if(lcard_set[5]==1){
                            arrange_ex_compact(card); }

                        mode_e=0; // „ÉÜ„Ç≠„Çπ„ÉàÁ∑®ÈõÜ„É¢„Éº„Éâ„ÅÆÂ†¥Âêà„ÅØ„É™„Çª„ÉÉ„Éà
                        sens_help(1);
                        mode_no_enhance(card);
                        bg_color(card); }}

            }}} // mem_paste()



    function moz(card){
        let wrap=card.querySelector('.ogpCard_wrap');
        let monitor_br=new MutationObserver(no_br);
        monitor_br.observe(wrap, {childList: true, subtree: true});

        no_br();

        function no_br(){
            let br_moz=wrap.querySelector('br[type="_moz"]');
            if(br_moz){
                br_moz.remove(); }
            let br_crm=wrap.querySelector('.ogpCard_content > br');
            if(br_crm){
                br_crm.remove(); }}}



    function sign(){
        monitor0.disconnect();

        let SVG_lz='<svg class="lz" viewBox="0 0 640 512">'+
            '<path d="M630 344L529 444c-9 9-25 9-34 0L394 344c-9-9-9-25 0-34l11'+
            '-11c10-10 25-9 34 .5L480 342V160H292a24 24 0 0 1-17-7l-16-16C244 '+
            '122 255 96 276 96H520c13 0 24 11 24 24v222l40-43c9-10 245-10 '+
            '34-.5l11 11c9 9 9 26-0 34zm-265 15A24 24 0 0 0 348 352H160V171l40 '+
            '43c9 10 25 10 34 .5l11-11c9-9 9-25 0-34L145 68c-9-9-25-9-34 0L10 '+
            '168c-9 9-9 25 0 35l11 11c10 10 25 9 34-.5L96 170V392c0 13 11 24 24 '+
            '24h244c21 0 32-26 17-41l-16-16z"></path></svg>';

        let SVG_al='<svg class="al" viewBox="0 0 256 480">'+
            '<path d="M192 127v257c0 18-22 27-34 14L29 270c-8-8-8-20 '+
            '0-28l129-129c13-13 34-4 34 14z"></path></svg>';

        let SVG_ac='<svg class="ac" viewBox="0 0 448 512">'+
            '<path fill="#fff" d="M400 32H48C22 32 0 54 0 80v352c0 27 22 48 48 '+
            '48h352c27 0 48-22 48-48V80c0-27-22-48-48-48z"></path></svg>';

        let SVG_ar='<svg class="ar" viewBox="0 0 144 480">'+
            '<path d="M0 385V127c0-18 22-27 34-14l129 129c8 8 8 20 0 '+
            '28L34 399C22 411 0 402 0 385z"></path></svg>';

        let SVG_h=
            '<svg id="h_hide" viewBox="0 0 150 150">'+
            '<path  fill="#fff" d="M66 13C56 15 47 18 39 24C-12 60 18 146 82 137C92 '+
            '135 102 131 110 126C162 90 128 4 66 13M68 25C131 17 145 117 81 '+
            '125C16 133 3 34 68 25M69 40C61 41 39 58 58 61C66 63 73 47 82 57C84 '+
            '60 83 62 81 65C77 70 52 90 76 89C82 89 82 84 86 81C92 76 98 74 100 66'+
            'C105 48 84 37 69 40M70 94C58 99 66 118 78 112C90 107 82 89 70 94z">'+
            '</path></svg>';

        let SVG_urlw=
            '<svg id="url_wide" viewBox="0 0 64 64">'+
            '<path style="fill:#444" d="M11 13C3 17 5 29 5 37C5 40 5 44 6 47C8 51 '+
            '15 55 19 52C20 51 20 50 19 49C15 45 11 46 11 38C11 33 10 25 12 21C14 '+
            '18 20 18 20 15C21 11 13 12 11 13M40 53C41 49 41 44 41 40L60 40L60 '+
            '27L41 27C41 23 41 18 40 14C34 17 29 22 25 27C23 29 21 31 21 34C21 '+
            '37 24 39 26 41C30 45 34 50 40 53z"></path></svg>';

        let SVG_urlc=
            '<svg viewBox="0 0 352 512">'+
            '<path d="M243 256l100-100c12-13 13-32 0-44l-22-22c-12-12-32-12-44 '+
            '0L176 189 76 89c-12-12-32-12-44 0L9 111c-12 12-12 32 0 44L109 256 9 '+
            '356c-12 12-12 32 0 44l22 22c12 12 32 12 44 0L176 323l100 100c12 12 32 '+
            '12 44 0l22-22c12-12 12-32 0-44L243 256z"></path></svg>';

        let SVG_w=
            '<svg id="write_url" viewBox="0 -10 256 256">';

        let SV_path=
            '<path style="fill:#333" d="M102 136L72 136C67 136 61 136 58 141C54 148 '+
            '59 153 63 158C72 169 82 180 91 191C100 201 109 212 118 222C122 226 '+
            '126 232 132 232C138 232 142 226 146 222C155 211 164 201 173 190C182 '+
            '179 192 169 201 158C205 153 210 148 207 142C203 136 198 136 192 '+
            '136L162 136C162 108 157 79 145 54C139 43 132 31 121 24C102 13 79 '+
            '13 58 17C53 18 39 20 38 27C37 31 49 29 51 29C67 27 85 32 96 45C102 53 '+
            '104 63 105 72C108 94 105 114 102 136z"/></svg>';

        let SVG_am=
            '<svg id="am_url" viewBox="0 0 448 512">'+
            '<path fill="#333" d="M257 163c-49 2-170 16-170 118 0 110 138 114 184 '+
            '43 7 10 35 38 45 47l57-56S341 289 341 261V114C341 89 317 32 229 32 141 '+
            '32 94 87 94 136l74 7c16-50 54-50 54-50 41-.1 36 30 36 69zm0 87c0 80-84 '+
            '68-84 17 0-47 51-57 84-58v41zm136 164c-8 10-70 67-175 67S34 409 10 '+
            '379c-7-8 1-11 6-8C89 415 203 489 388 401c8-4 13 2 6 12zm40 2c-7 16-16 '+
            '27-21 31-6 5-10 3-7-4s19-47 13-55c-7-8-37-4-48-3-11 1-13 2-14-.3-2-6 '+
            '22-16 38-18 16-2 41-.8 46 6 4 5 0 27-7 43z"></path></svg>';

        let SVG_link=
            '<svg id="link_mark" viewBox="0 0 32 32">'+
            '<path style="fill: currentColor" d="M16 20C14 15 14 13 18 9C20 7 24 4 '+
            '26 7C27 10 23 16 23 19C25 18 27 16 29 14C32 9 30 1 23 1C15 2 4 17 '+
            '16 20M16 12C18 17 18 19 14 23C12 25 8 28 6 25C5 22 9 16 9 13C7 14 '+
            '5 16 3 18C-0 23 2 31 9 31C17 30 28 15 16 12z"></path></svg>';

        let SVG_mpl=
            '<svg id="memo_plus" viewBox="-45 -20 540 540">'+
            '<path fill="#333" d="M416 208H272V64c0-18-14-32-32-32h-32c-18 '+
            '0-32 14-32 32v144H32c-18 0-32 14-32 32v32c0 18 14 32 32 32h144v '+
            '144c0 18 14 32 32 32h32c18 0 32-14 32-32V304h144c18 0 32-14 '+
            '32-32v-32c0-18-14-32-32-32z"></path></svg>';

        let SVG_mps=
            '<svg id="memo_paste" viewBox="0 -10 256 256">';


        let disp=document.createElement("div");
        disp.setAttribute("id", "disp_le");
        disp.innerHTML=
            '<span class="e_hint"></span>'+
            '<span class="ls_hint hint"><b>‚ñº</b> CardÊåáÂÆöÔºöCtrl+Click</span>'+
            '<span class="lz_hint hint">ÂûãÂ§âÊèõÔºö'+ SVG_lz +'</span>„ÄÄ'+
            'ÈÖçÁΩÆÔºö'+ SVG_al + SVG_ac + SVG_ar + '„ÄÄ'+
            '<span class="lc_hint hint">ËÉåÊôØËâ≤Ôºö'+
            '<span id="lc_w"><span id="lc_color">„ÄÄ</span></span></span> '+
            '<input id="lc_trance" type="number" max="10" min="0.1" step="0.1">'+
            'ÔºöÊøÉÂ∫¶„ÄÄ<span class="tc_hint hint">ÊñáÂ≠óËâ≤Ôºö'+
            '<span id="tc_w"><span id="tc_color">„ÄÄ</span></span></span> '+

            '<div id="ex_disp">'+
            SVG_h + SVG_urlw +
            '„ÄÄ„ÄÄ <input id="url_input" type="url" placeholder="Â§âÊõ¥„Åô„ÇãURL„ÇíÂÖ•Âäõ" '+
            'autocomplete="off">'+
            '<span class="url_clear">'+ SVG_urlc +'</span>'+
            '<span id="lw_h" class="lw_hint hint">'+ SVG_w + SV_path +'</span> '+
            '<span id="la_h" class="la_hint hint">'+ SVG_am +'</span>'+
            '„ÄÄ Êû†Á∑öËâ≤Ôºö<span class="lb_hint hint">'+
            '<span id="lb_w"><span id="lb_color">„ÄÄ</span></span></span> '+
            '<span id="lb_disp">„ÄÄ</span>'+
            '<input id="lborder" type="number" max="5" min="0"> '+
            '<span id="lbr_disp">„ÄÄ</span>'+
            '<input id="lbr" type="number" max="30" min="0">'+
            '<span class="lv_hint hint">'+ SVG_link +'</span>„ÄÄ'+
            'MÔºö<span class="mpl_hint hint">'+ SVG_mpl +'</span> '+
            '<span class="mp_hint hint">'+ SVG_mps + SV_path +'</span>'+
            '</div>';

        let css=
            '#cke_1_contents { display: flex; flex-direction: column; } '+
            '#disp_le { margin: 0 0 5px; padding: 4px 0 1px; white-space: nowrap; '+
            'font: normal 16px/24px Meiryo; color: #fff; background: #607d8b; '+
            'user-select: none; } '+

            '#disp_le .e_hint { position: absolute; background: #607d8b; z-index: 1; } '+
            '#disp_le .hint { position: relative; } '+
            '#disp_le .hint:hover::after { position: absolute; z-index: 1; height: 23px; '+
            'padding: 1px 9px 0; font: 16px Meiryo; color: #fff; background: #000; } '+
            '#disp_le .ls_hint { margin: 0 45px 0 15px; } '+
            '#disp_le .ls_hint b { color: #a4fff7; } '+
            '#disp_le .lz_hint.hint:hover::after { top: 27px; left: -213px; '+
            'content: "„ÄÄ„ÄÄ„ÄÄ„ÄÄ„ÄÄÊ®ôÊ∫ñ‚ñ∏‰∏≠Âûã‚ñ∏Â∞èÂûãÔºöClick„ÄÄ‚ñ≤„ÄÄ„ÄÄ'+
            'ËªΩÈáèÂåñCard„Å´Â§âÊõ¥ÔºöCtrl+Click„ÄÄ„ÄÄ„ÄÄ"; } '+
            '#disp_le .lc_hint.hint:hover::after { top: 27px; left: -161px; '+
            'content: "„ÄÄ„Ç´„É©„Éº„Éë„É¨„ÉÉ„ÉàË°®Á§∫ÔºöClick ‚ñ≤ „ÄÄ"; } '+
            '#disp_le .tc_hint.hint:hover::after { top: 27px; left: -161px; '+
            'content: "„ÄÄ„Ç´„É©„Éº„Éë„É¨„ÉÉ„ÉàË°®Á§∫ÔºöClick ‚ñ≤„ÄÄ"; } '+
            '#disp_le .lw_hint.hint:hover::after { top: -29px; left: -210px; '+
            'content: "„ÄÄ„É™„É≥„ÇØURL„ÅÆÊõ∏ÊèõÔºöClick ‚ñº„ÄÄ '+
            '„Éâ„É°„Ç§„É≥Ë°®Á§∫ÈÉ®„Å´Ë®òÂÖ•ÔºöShift+Click„ÄÄ"; } '+
            '#disp_le .hint.lw_hint_w:hover::after { top: -29px; left: -503px; '+
            'content: "„ÄÄ„Éâ„É°„Ç§„É≥Ë°®Á§∫ÈÉ®„Å´Ë®òÂÖ•ÔºöShift+Click„ÄÄ„ÄÄ'+
            '„É™„É≥„ÇØURL„ÅÆÊõ∏ÊèõÔºöClick ‚ñº„ÄÄ"; } '+
            '#disp_le .la_hint.hint:hover::after { top: -29px; left: -276px; '+
            'content: "„ÄÄ„É™„É≥„ÇØURL„ÅÆ‰∏çË¶ÅÈÉ®„ÇíÁúÅÁï• : Click ‚ñº„ÄÄ"; } '+
            '#disp_le .lb_hint.hint:hover::after { top: -29px; left: -227px; '+
            'content: "„ÄÄ„Ç´„É©„Éº„Éë„É¨„ÉÉ„ÉàË°®Á§∫ÔºöClick ‚ñº„ÄÄ"; } '+
            '#disp_le .lv_hint.hint:hover::after { top: -29px; left: -227px; '+
            'content: "„ÄÄ„Ç´„É©„Éº„Éë„É¨„ÉÉ„ÉàË°®Á§∫ÔºöClick ‚ñº„ÄÄ"; } '+
            '#disp_le .mpl_hint.hint:hover::after { top: -29px; left: -178px; '+
            'content: "„ÄÄ„Éá„Ç∂„Ç§„É≥ÁôªÈå≤ÔºöClick ‚ñº „ÄÄ"; } '+
            '#disp_le .mp_hint.hint:hover::after { top: -29px; left: -472px; '+
            'content: "„Éâ„É°„Ç§„É≥Ë°®Á§∫Âº∑Ë™øÔºöShift+Click„ÄÄ„ÄÄÁôªÈå≤„Éá„Ç∂„Ç§„É≥„ÇíÈÅ©Áî®ÔºöClick ‚ñº"; } '+

            '#disp_le svg { cursor: pointer; width: 16px; height: 16px; padding: 1px; '+
            'border-radius: 2px; background: #fff; vertical-align: -3px; } '+
            '#disp_le .lz { width: 21px; fill: #333; } '+
            '#disp_le .al, #disp_le .ar { fill: #333; } '+
            '#disp_le .al, #disp_le .ac { margin-right: 4px; } '+
            '#lc_w, #tc_w { display: inline-block; overflow: hidden; width: 16px; '+
            'height: 16px; border: 1px solid #fff; background: #fff; vertical-align: -3px; } '+
            '#lc_color, #tc_color { cursor: pointer; background: #fff; } '+
            '#lc_trance { height: 22px; width: 15px; border: none; vertical-align: 1px; '+
            'background: transparent; } '+
            '#lc_trance::-webkit-inner-spin-button { opacity: 1; } '+

            '#ex_disp { position: relative; } '+
            '#h_hide { position: absolute; top: 6px; left: 4px; '+
            'background: none !important; } '+
            '#url_wide { position: absolute; top: 4px; left: 37px; '+
            'background: #eceff1 !important; padding: 2px 3px 3px !important; '+
            'border-radius: 0 !important; display: none; } '+
            '.lw_hint_w +#la_h { margin-right: 400px; } '+
            '#url_input { height: 18px; width: 265px; padding: 3px 22px 0 12px; '+
            'margin: 2px 10px 2px -2px; color: #000; } '+
            '#url_input.url_input_w { width: 576px; padding: 3px 22px 0 32px; } '+
            '#disp_le .url_clear { margin: 0 12px 0 -32px; fill: #444; } '+
            '#disp_le .url_clear:hover { fill: red; } '+
            '#lb_w { display: inline-block; width: 16px; height: 16px; overflow: hidden; '+
            'border: 1px solid #fff; background: #fff; vertical-align: -3px; } '+
            '#lb_color { cursor: pointer; background: #fff; } '+
            '#lb_disp, #lbr_disp { display: inline-block; position: relative; width: 32px; '+
            'color: #fff; background: #607d8b; } '+
            '#lborder { height: 22px; width: 15px; border: none; background: none; } '+
            '#lborder::-webkit-inner-spin-button { opacity: 1; } '+
            '#lbr_disp { width: 36px; margin-left: -6px; text-align: center; } '+
            '#lbr { height: 22px; width: 15px; border: none; background: none; '+
            'margin-right: 20px; } '+
            '#lbr::-webkit-inner-spin-button { opacity: 1; } ';


        if(ua==1){
            css+='#lc_trance { width: 18px; } #lborder { width: 32px; }'; }


        let style=document.createElement('style');
        style.setAttribute("id", "le_style");
        style.innerHTML=css;
        disp.appendChild(style);

        editor_iframe=document.querySelector('.cke_wysiwyg_frame');
        if(editor_iframe){
            if(!target0.querySelector('#disp_le')){
                target0.insertBefore(disp, editor_iframe); }

            iframe_doc=editor_iframe.contentWindow.document;
            if(iframe_doc){
                let iframe_html=iframe_doc.querySelector('html');
                iframe_body=iframe_doc.querySelector('body');
                if(iframe_html && iframe_body){
                    let card_style=iframe_doc.createElement('style');
                    let css=
                        '.edit_card { outline: 2px solid #2196f3; outline-offset: 6px; } '+
                        '.edit_card_e .ogpCard_link { height: auto !important; } '+
                        '.edit_card_e .ogpCard_title { display: unset !important; '+
                        'max-height: unset !important; overflow: visible !important; } '+
                        '.edit_card_e .ogpCard_description { white-space: normal !important; '+
                        'overflow: visible !important; } '+
                        '.edit_card_e .ogpCard_urlText { white-space: normal !important; '+
                        'height: auto !important; width: 100%; } '+
                        '.ogpCard_wrap *{ background-color: initial; }'; // cke editor„ÅÆ„É™„Çª„ÉÉ„Éà

                    card_style.setAttribute("id", "card_style");
                    card_style.innerHTML=css;
                    if(!iframe_html.querySelector('#card_style')){
                        iframe_html.appendChild(card_style); }}}}

        monitor0.observe(target0, {childList: true});

        let disp_le=document.querySelector('#disp_le');
        disp_le.style.display='block';

        let photos_w=document.querySelector('#js-photos-wrapper');
        photos_w.style.background='#607d8b'; // ÁîªÂÉè„Éë„É¨„ÉÉ„Éà„Å®„É°„Éã„É•„Éº„Éê„ÉºËâ≤„ÇíÁµ±‰∏Ä

        bg_reset();
        tx_reset();
        url_reset(); // urlÂÖ•ÂäõÊû†ÂπÖ„Çí„É™„Çª„ÉÉ„Éà
        bd_reset();
        sv_reset();
        help_set();

    } // sign()



    function sign_clear(){
        if(target0.querySelector('#disp_le')){
            target0.querySelector('#disp_le').style.display='none'; }
        let photos_w=document.querySelector('#js-photos-wrapper');
        photos_w.style.background='';
        let url_input=document.querySelector('#url_input');
        url_input.value=''; }



    function url_reset(){
        let url_wide=document.querySelector('#url_wide');
        let url_input=document.querySelector('#url_input');
        let lw_h=document.querySelector('#lw_h');
        if(url_input.classList.contains('url_input_w')){
            url_input.classList.remove('url_input_w');
            lw_h.classList.remove('lw_hint_w');
            lw_h.classList.add('lw_hint');
            url_wide.style.display='none'; }}



    function before_end(){
        editor_iframe=document.querySelector('.cke_wysiwyg_frame');
        let submitButton=document.querySelectorAll('.js-submitButton');
        submitButton[0].addEventListener("click", all_close, false);
        submitButton[1].addEventListener("click", all_close, false);

        function all_close(){
            if(mode==1){
                if(!editor_iframe){ // HTMLË°®Á§∫„ÅÆÂ†¥Âêà
                    alert("‚õî„ÄÄLinkCard Editor „ÅåÂá¶ÁêÜ„ÇíÁµÇ‰∫Ü„Åó„Å¶„ÅÑ„Åæ„Åõ„Çì\n\n"+
                          "„ÄÄ„ÄÄ ÈÄöÂ∏∏Ë°®Á§∫ÁîªÈù¢„Å´Êàª„Çä Á∑®ÈõÜ„ÇíÁµÇ‰∫Ü„Åó„Å¶„Åè„Å†„Åï„ÅÑ");
                    event.stopImmediatePropagation();
                    event.preventDefault(); }
                else if(editor_iframe){ // ÈÄöÂ∏∏Ë°®Á§∫„ÅÆÂ†¥Âêà
                    mode=0;
                    card_close(); }}}
    } // before_end()



    function help_set(){
        if(lcard_set[11]==1){
            let hints=document.querySelectorAll('#disp_le .hint');
            for(let k=0; k<hints.length; k++){
                hints[k].classList.replace('hint', 'hint_'); }}

        let h_hide=document.querySelector('#h_hide');
        if(h_hide){
            h_hide.onclick=function(){
                let ok=confirm(
                    "„ÄÄ„ÄÄ‚ö´ Êìç‰ΩúË™¨Êòé„ÅÆ„Éò„É´„Éó„ÅÆË°®Á§∫„ÉªÈùûË°®Á§∫„ÇíÂ§âÊõ¥„Åó„Åæ„Åô\n"+
                    "„ÄÄ„ÄÄ„ÄÄ  Â∑¶Á´Ø„ÅÆ (?) „Éú„Çø„É≥„ÇíÊäº„Åó„Å¶‰ΩïÂ∫¶„Åß„ÇÇÂ§âÊõ¥„Åß„Åç„Åæ„Åô");
                if(ok){
                    help_toggle();
                    let write_json=JSON.stringify(lcard_set);
                    localStorage.setItem('LinkCard Style', write_json); }
                manual_disp(); }}


        function help_toggle(){
            if(lcard_set[11]==0){
                let hints=document.querySelectorAll('#disp_le .hint');
                for(let k=0; k<hints.length; k++){
                    hints[k].classList.replace('hint', 'hint_'); } // „Éí„É≥„ÉàÈùûË°®Á§∫
                lcard_set[11]=1; }
            else{
                let hints=document.querySelectorAll('#disp_le .hint_');
                for(let k=0; k<hints.length; k++){
                    hints[k].classList.replace('hint_', 'hint'); } // „Éí„É≥„Éà„ÇíË°®Á§∫
                lcard_set[11]=0; }}


        function manual_disp(){
            let SVG_link=
                '<svg style="height: 20px; width: 24px; vertical-align: -4px" '+
                'viewbox="0 0 24 24">'+
                '<path fill="#0080ba" d="M14 5a1 1 0 1 1 0-2h6a1 1 0 0 1 1 1v6a1 '+
                '1 0 1 1-2 0V6l-9 9a1 1 0 0 1-1-1L18 5H14zM3 7a2 2 0 0 1 2-2h5a1 '+
                '1 0 1 1 0 2H5v12h12v-5a1 1 0 1 1 2 0v5a2 2 0 0 1-2 2H5a2 2 0 0 '+
                '1-2-2V7z"></path></svg>';

            let manu_link=document.createElement('div');
            manu_link.setAttribute("id", "le_manual");
            manu_link.innerHTML=
                '<a href="https://ameblo.jp/personwritep/entry-12713507026.html"'+
                'target="_blank" rel="noopener noreferrer" '+
                'style="font: bold 16px Meiryo; padding: 4px 12px 2px; '+
                'border: 1px solid #3970B5; border-radius: 4px; background: #fff; '+
                'box-shadow: 0px 10px 100px 20px rgb(0 0 0 / 20%); '+
                'text-decoration: none; cursor: pointer; '+
                'position: fixed; top: 20px; left: 20px; z-index: 100; }">'+
                '<span style="color:#0080ba">„Éû„Éã„É•„Ç¢„É´„Éö„Éº„Ç∏„ÇíÈñã„Åè</span>'+
                SVG_link +'</a>';

            if(!document.querySelector('#le_manual')){
                document.body.appendChild(manu_link); }

            setTimeout(()=>{
                document.querySelector('#le_manual').remove();
            }, 5000); }

    } // help_set()


} // main()
